--- REL_17_5_WASM/src/backend/libpq/pqcomm.c
+++ REL_17_5_WASM-pglite/src/backend/libpq/pqcomm.c
@@ -131,8 +131,15 @@
 static char *PqRecvBuffer;
 static int	PqRecvPointer;
 static int	PqRecvLength;
+volatile int querylen = 0;
+volatile FILE* queryfp = NULL;
 #endif
 
+/* pglite specific */
+extern int cma_rsize;
+extern bool sockfiles;
+
+
 /*
  * Message status
  */
@@ -320,9 +327,7 @@
 	AddWaitEventToSet(FeBeWaitSet, WL_POSTMASTER_DEATH, PGINVALID_SOCKET,
 					  NULL, NULL);
 #else /* WASM */
-    PDEBUG("# 220: FIXME: socketfile");
-    #pragma message "FIXME: socketfile"
-    /* because we fill before starting reading message */
+    /* because we may fill before starting reading message */
     PqRecvBuffer = &PqRecvBuffer_static[0];
 #endif /* WASM */
 	/*
@@ -923,6 +928,20 @@
 		else
 			PqRecvLength = PqRecvPointer = 0;
 	}
+#if defined(__EMSCRIPTEN__) || defined(__wasi__)
+    if (queryfp && querylen) {
+        int got = fread( PqRecvBuffer, 1, PQ_RECV_BUFFER_SIZE - PqRecvPointer, queryfp);
+        querylen -= got;
+        PqRecvLength += got;
+        if (querylen<=0) {
+            PDEBUG("# 931: could close fp early here " __FILE__);
+            queryfp = NULL;
+        }
+        if (got>0)
+    		return 0;
+    }
+    return EOF;
+#endif
 
 	/* Ensure that we're in blocking mode */
 	socket_set_nonblocking(false);
@@ -1025,7 +1044,9 @@
 		*c = PqRecvBuffer[PqRecvPointer++];
 		return 1;
 	}
-
+#if defined(__EMSCRIPTEN__) || (__wasi__)
+puts("# 1044: pq_getbyte_if_available N/I in " __FILE__ ); abort();
+#else
 	/* Put the socket into non-blocking mode */
 	socket_set_nonblocking(true);
 
@@ -1062,7 +1083,7 @@
 		/* EOF detected */
 		r = EOF;
 	}
-
+#endif
 	return r;
 }
 
@@ -1129,6 +1150,7 @@
 	return 0;
 }
 
+
 /* --------------------------------
  *		pq_buffer_remaining_data	- return number of bytes in receive buffer
  *
@@ -1150,19 +1172,25 @@
  *		This must be called before any of the pq_get* functions.
  * --------------------------------
  */
-#if defined(I_EMSCRIPTEN) || defined(I_WASI)
+#if defined(__EMSCRIPTEN__) || defined(__wasi__)
 EMSCRIPTEN_KEEPALIVE void
 pq_recvbuf_fill(FILE* fp, int packetlen) {
-    fread( PqRecvBuffer, packetlen, 1, fp);
+    if (packetlen>PQ_RECV_BUFFER_SIZE) {
+        int got = fread( PqRecvBuffer, 1, PQ_RECV_BUFFER_SIZE, fp);
+        queryfp = fp;
+        querylen = packetlen - got;
+        PqRecvLength = got;
+    } else {
+        fread( PqRecvBuffer, packetlen, 1, fp);
+        PqRecvLength = packetlen;
+        queryfp = NULL;
+        querylen = 0;
+    }
     PqRecvPointer = 0;
-    PqRecvLength = packetlen;
-#if PDEBUG
-        printf("# 1199: pq_recvbuf_fill cma_rsize=%d PqRecvLength=%d buf=%p reply=%p\n", cma_rsize, PqRecvLength, &PqRecvBuffer[0], &PqSendBuffer[0]);
-#endif
-
 }
+
 #endif
-extern int cma_rsize;
+
 static char * PqSendBuffer_save;
 void
 pq_startmsgread(void)
@@ -1175,9 +1203,14 @@
 		ereport(FATAL,
 				(errcode(ERRCODE_PROTOCOL_VIOLATION),
 				 errmsg("terminating connection because protocol synchronization was lost")));
-#if defined(I_EMSCRIPTEN) || defined(I_WASI)
+#if defined(__EMSCRIPTEN__) || defined(__wasi__)
     if (!pq_buffer_remaining_data()) {
-        if (cma_rsize) {
+        if (sockfiles) {
+            PqRecvBuffer = &PqRecvBuffer_static[0];
+            if (PqSendBuffer_save)
+                PqSendBuffer=PqSendBuffer_save;
+            PqSendBufferSize = PQ_SEND_BUFFER_SIZE;
+        } else {
             PqRecvPointer = 0;
             PqRecvLength = cma_rsize;
             PqRecvBuffer = (char*)0x1;
@@ -1186,15 +1219,10 @@
             PqSendBuffer_save = PqSendBuffer;
             PqSendBuffer = 2 + (char*)(cma_rsize);
             PqSendBufferSize = (CMA_MB*1024*1024) - (int)(&PqSendBuffer[0]);
-        } else {
-            PqRecvBuffer = &PqRecvBuffer_static[0];
-            if (PqSendBuffer_save)
-                PqSendBuffer=PqSendBuffer_save;
-            PqSendBufferSize = PQ_SEND_BUFFER_SIZE;
         }
     }
 #if PDEBUG
-        printf("# 1199: pq_startmsgread cma_rsize=%d PqRecvLength=%d buf=%p reply=%p\n", cma_rsize, PqRecvLength, &PqRecvBuffer[0], &PqSendBuffer[0]);
+        printf("# 1225: pq_startmsgread cma_rsize=%d PqRecvLength=%d buf=%p reply=%p\n", cma_rsize, PqRecvLength, &PqRecvBuffer[0], &PqSendBuffer[0]);
 #endif
 
 #endif
@@ -1325,21 +1353,17 @@
 extern int SOCKET_DATA;
 static int
 internal_putbytes(const char *s, size_t len) {
-	if (PqSendPointer >= PqSendBufferSize) {
-        fprintf(stderr, "# 1329: overflow %d >= %d cma_rsize=%d CMA=%d\n", PqSendPointer, PqSendBufferSize,cma_rsize, CMA_MB);
-    }
-
-    if (!cma_rsize) {
-        int wc=      fwrite(s, 1, len, SOCKET_FILE);
-        SOCKET_DATA+=wc;
-    } else {
-	    size_t		amount;
+    size_t amount;
+    if (!sockfiles) {
 	    while (len > 0) {
-		    /* If buffer is full, then flush it out */
+		    /* If buffer is full, then flush it out from cma to file and continue from there */
 		    if (PqSendPointer >= PqSendBufferSize) {
-			    socket_set_nonblocking(false);
-			    if (internal_flush())
-				    return EOF;
+                int redirected = fwrite(PqSendBuffer, 1, PqSendPointer, SOCKET_FILE);
+                sockfiles = true;
+#if PGDEBUG
+                fprintf(stderr, "# 1364: overflow %zu >= %d redirect=%d cma_rsize=%d CMA_MB=%d \n", PqSendPointer, PqSendBufferSize, redirected, cma_rsize, CMA_MB);
+#endif
+                break;
 		    }
 		    amount = PqSendBufferSize - PqSendPointer;
 		    if (amount > len)
@@ -1351,6 +1375,11 @@
             SOCKET_DATA+=amount;
 	    }
     }
+
+    if (sockfiles) {
+        int wc=      fwrite(s, 1, len, SOCKET_FILE);
+        SOCKET_DATA+=wc;
+    }
     return 0;
 }
 
@@ -1362,7 +1391,7 @@
 static int
 internal_flush(void) {
     /*  no flush for raw wire */
-    if (!cma_rsize) {
+    if (sockfiles) {
     	PqSendStart = PqSendPointer = 0;
     }
 	return 0;
